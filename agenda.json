---
permalink: /agenda.json
layout: null
---

[
{% assign events = site.events | sort: "start" %}
{% for event in events %}
  {% assign venue = site.venues | where: "slug", event.venue | first %}

  {% assign event_choirs = "" | split: "" %}
  
  {% for choir_entry in event.choirs %}
    {% assign choir = site.choirs | where: "slug", choir_entry.slug | first %}
  
    {% if choir_entry.conductors %}
      {% assign conductor_slugs = choir_entry.conductors %}
    {% elsif choir and choir.conductors %}
      {% assign conductor_slugs = choir.conductors %}
    {% else %}
      {% assign conductor_slugs = "" | split: "" %}
    {% endif %}
  
    {% assign conductor_names = "" | split: "" %}
    {% for cslug in conductor_slugs %}
      {% assign conductor = site.conductors | where: "slug", cslug | first %}
      {% if conductor %}
        {% assign conductor_names = conductor_names | push: conductor.name %}
      {% else %}
        {% assign conductor_names = conductor_names | push: cslug %}
      {% endif %}
    {% endfor %}
  
    {% capture choir_json %}
    {
      "slug": {{ choir_entry.slug | jsonify }},
      "name": {{ choir.name | default: choir_entry.slug | jsonify }},
      "conductors": {{ conductor_slugs | jsonify }},
      "conductor_names": {{ conductor_names | jsonify }}
    }
    {% endcapture %}
    
    {% assign event_choirs = event_choirs | push: choir_json %}

  {% endfor %}

  {% if venue %}
    {% assign city = venue.city %}
  {% else %}
    {% assign city = nil %}
  {% endif %}

  {
    "title": {{ event.title | jsonify }},
    "type": {{ event.type | default: "concert" | jsonify }},
    "url": {{ event.url | relative_url | jsonify }},
    "start": {{ event.start | jsonify }},
    "choirs": [
      {{ event_choirs | join: "," }}
    ],
    "venue": {{ event.venue | jsonify }},
    "city": {{ city | jsonify }}
  }{% unless forloop.last %},{% endunless %}
{% endfor %}
]
